# Amazon ASIN æ•°æ®æµæ°´çº¿ï¼ˆä¸­æ–‡ä½¿ç”¨æ‰‹å†Œï¼‰

æœ¬ä»“åº“é¢å‘åˆå­¦è€…æä¾›äº†ä¸€å¥—å¯è½åœ°çš„ Amazon ASIN æ•°æ®åˆ†æä¸å»ºæ¨¡æ–¹æ¡ˆï¼Œæ¶µç›–æ•°æ®é‡‡é›†ã€æ¸…æ´—ã€ç‰¹å¾æ„å»ºã€è¯„åˆ†ã€è®­ç»ƒã€æ¨ç†ã€æŠ¥è¡¨ä»¥åŠè¿ç»´æ²»ç†ã€‚æœ¬æ–‡æ¡£ä»¥â€œåˆ†æ­¥å¯¼èˆªâ€çš„æ–¹å¼ï¼Œå¸®åŠ©ä½ ä»é›¶æ­å»ºå¹¶è¿è¡Œæ•´æ¡æµæ°´çº¿ã€‚

## ğŸ“Œ å¯¼èˆªé€Ÿè§ˆ

- [æ–°æ‰‹å¿«é€Ÿä½“éªŒè·¯çº¿å›¾](#æ–°æ‰‹å¿«é€Ÿä½“éªŒè·¯çº¿å›¾)
- [ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„](#ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„)
- [ç«¯åˆ°ç«¯æ•°æ®æµæ°´çº¿æ‰‹å†Œ](#ç«¯åˆ°ç«¯æ•°æ®æµæ°´çº¿æ‰‹å†Œ)
  - [1. å‡­è¯ä¸é…ç½®å‡†å¤‡](#1-å‡­è¯ä¸é…ç½®å‡†å¤‡)
  - [2. é‡‡é›†ä¸å…¥æ¹–](#2-é‡‡é›†ä¸å…¥æ¹–)
  - [3. æ ‡å‡†åŒ–ä¸è´¨é‡æ ¡éªŒ](#3-æ ‡å‡†åŒ–ä¸è´¨é‡æ ¡éªŒ)
  - [4. ç‰¹å¾æ„å»º](#4-ç‰¹å¾æ„å»º)
  - [5. çˆ†å‘åº¦è¯„åˆ†](#5-çˆ†å‘åº¦è¯„åˆ†)
  - [6. æ•°æ®å¯¼å‡ºä¸æŠ¥è¡¨](#6-æ•°æ®å¯¼å‡ºä¸æŠ¥è¡¨)
- [æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°æ‰‹å†Œ](#æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°æ‰‹å†Œ)
- [åœ¨çº¿æ¨ç†ä¸æœåŠ¡æ‰‹å†Œ](#åœ¨çº¿æ¨ç†ä¸æœåŠ¡æ‰‹å†Œ)
- [æŠ¥è¡¨/BI ä¸ AI æ‰©å±•åŠŸèƒ½](#æŠ¥è¡¨bi-ä¸-ai-æ‰©å±•åŠŸèƒ½)
- [ç›‘æ§ã€æ²»ç†ä¸æ’éšœæŒ‡å—](#ç›‘æ§æ²»ç†ä¸æ’éšœæŒ‡å—)
- [ä¸Šçº¿å‰ç«¯åˆ°ç«¯éªŒæ”¶æ¸…å•](#ä¸Šçº¿å‰ç«¯åˆ°ç«¯éªŒæ”¶æ¸…å•)
- [Docker éƒ¨ç½²å…¨é›†](#docker-éƒ¨ç½²å…¨é›†)
- [å¸¸è§é—®é¢˜ä¸åç»­è§„åˆ’](#å¸¸è§é—®é¢˜ä¸åç»­è§„åˆ’)

> **é˜…è¯»å»ºè®®**ï¼šæŒ‰é¡ºåºå®Œæˆâ€œæ–°æ‰‹å¿«é€Ÿä½“éªŒè·¯çº¿å›¾â€çš„ä¸‰æ­¥æ“ä½œåï¼Œå¯æ ¹æ®éœ€æ±‚è·³è½¬åˆ°å¯¹åº”ç« èŠ‚æ·±å…¥å­¦ä¹ ï¼›æ‰€æœ‰ç« èŠ‚æ ‡é¢˜å‡å¯åœ¨ç›®å½•ä¸­ç›´æ¥ç‚¹å‡»è·³è½¬ã€‚

## æ–°æ‰‹å¿«é€Ÿä½“éªŒè·¯çº¿å›¾

1. **å…‹éš†é¡¹ç›®å¹¶å®‰è£…ä¾èµ–**
   ```bash
   git clone https://github.com/your-org/amazon-data-predict.git
   cd amazon-data-predict
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. **å¡«å¥½å‡­è¯å¹¶è¿è¡Œä¸€æ¬¡å¹²å‡€çš„é‡‡é›† â†’ æ¸…æ´— â†’ è¯„åˆ†æµç¨‹**
   ```bash
   cp config/secrets.example.env .env   # æŒ‰æç¤ºå¡«å†™ Amazon/æ•°æ®åº“å‡­è¯
   python -m pipelines.ingest_raw --date 2024-05-01
   python -m pipelines.etl_standardize --date 2024-05-01
   python -m pipelines.score_baseline --date 2024-05-01
   ```
3. **æ‰“å¼€å‘¨æŠ¥æˆ–ä»ªè¡¨ç›˜ç¤ºä¾‹éªŒè¯ç»“æœ**
   ```bash
   python -m reporting.weekly_report --date 2024-05-01 --output reports/
   ```
   å¦‚æœéœ€è¦å¯è§†åŒ–ï¼Œå¯è¿æ¥è‡³æ•°æ®åº“æˆ–æŸ¥çœ‹ `reports/weekly_report_2024-05-01.xlsx`ã€‚

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ å·²å®Œæˆä»æ•°æ®é‡‡é›†åˆ°ç»“æœæ¶ˆè´¹çš„æœ€å°é—­ç¯ï¼Œæ¥ä¸‹æ¥å¯æŒ‰å¯¼èˆªè‡ªç”±æ¢ç´¢ã€‚

## ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„

### å¿…å¤‡å·¥å…·

- Python 3.10+ï¼ˆå»ºè®®ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼‰
- PostgreSQL æˆ–å…¼å®¹æ•°æ®åº“ï¼ˆç”¨äºå­˜å‚¨æ•°æ®ä¸ç‰¹å¾ï¼‰
- å¯é€‰ï¼šDocker / Docker Composeï¼ˆç”¨äºä¸€é”®éƒ¨ç½²ï¼‰
- å¯é€‰ï¼šMLflowï¼ˆè·Ÿè¸ªæ¨¡å‹è®­ç»ƒï¼‰

### é¡¹ç›®ç»“æ„ä¸€è§ˆ

```
config/                 # ç¯å¢ƒé…ç½®ä¸å‡­è¯æ¨¡æ¿
connectors/             # å¸¦é™æµä¸é‡è¯•é€»è¾‘çš„ API å®¢æˆ·ç«¯
pipelines/              # é‡‡é›†ã€ETLã€ç‰¹å¾ä¸è¯„åˆ†çš„ç¼–æ’è„šæœ¬
storage/                # æ•°æ®åº“ DDLã€ç‰¹å¾ä»“åº“ schemaã€è¿ç§»è„šæœ¬
reporting/              # SQL æŸ¥è¯¢ä¸å‘¨æŠ¥ã€ä»ªè¡¨ç›˜ç”Ÿæˆè„šæœ¬
training/               # æ¨¡å‹è®­ç»ƒã€æ³¨å†Œä¸è¯„ä¼°å·¥å…·
inference/              # åœ¨çº¿æ¨ç†è„šæœ¬ä¸æœåŠ¡é…ç½®
ops/                    # Dockerã€è°ƒåº¦ã€è¿ç»´ç›¸å…³èµ„æº
utils/                  # æ—¥å¿—ã€é…ç½®ã€æ ¡éªŒç­‰é€šç”¨å·¥å…·
tests/                  # connectorsã€pipelines ç­‰å•å…ƒæµ‹è¯•
```

å»ºè®®å…ˆæµè§ˆ `config/`ã€`pipelines/` ä¸ `reporting/` ç›®å½•ï¼Œäº†è§£å‚æ•°é…ç½®ä¸æ•°æ®æµå‘ã€‚

## ç«¯åˆ°ç«¯æ•°æ®æµæ°´çº¿æ‰‹å†Œ

### 1. å‡­è¯ä¸é…ç½®å‡†å¤‡

1. å¤åˆ¶ `.env` æ¨¡æ¿å¹¶å¡«å†™å¿…éœ€å˜é‡ï¼š
   ```bash
   cp config/secrets.example.env .env
   ```
   - `AMAZON_PARTNER_TAG`ã€`AMAZON_ACCESS_KEY`ã€`AMAZON_SECRET_KEY`ï¼šAmazon API å‡­è¯ã€‚
   - `DATABASE_URL`ï¼šPostgreSQL è¿æ¥ä¸²ï¼ˆç¤ºä¾‹ï¼š`postgresql://user:pass@localhost:5432/asin`ï¼‰ã€‚
2. æ ¸å¯¹ `config/settings.yaml`ï¼š
   - `ingest.rate_limit` æ§åˆ¶ API è°ƒç”¨é¢‘ç‡ã€‚
   - `storage.raw_bucket`/`warehouse.schema` æŒ‡å®šæ•°æ®è½åœ°ä½ç½®ã€‚
   - `ai.enabled` é»˜è®¤ä¸º `false`ï¼Œå¦‚éœ€å¯ç”¨ AI æ‘˜è¦ã€å…³é”®è¯åŠŸèƒ½è¯·åœ¨ä¸Šçº¿å‰äººå·¥ç½®ä¸º `true` å¹¶é…ç½®å¯¹åº”è¡¨å/è·¯å¾„ã€‚
3. è‹¥éœ€è‡ªå®šä¹‰æ ‡ç­¾é˜ˆå€¼ï¼Œè¯·å¤åˆ¶ç¤ºä¾‹ï¼š
   ```bash
   cp config/labeling.yaml.example config/labeling.yaml
   ```
   ç„¶åæ ¹æ®ä¸šåŠ¡è°ƒå‚ `thresholds`ï¼ˆé»˜è®¤ r=1.6ã€p=0.2=20%ã€delta=1.0ï¼‰ã€‚
4. æ ¹æ®ç¯å¢ƒå¯¼å…¥æ•°æ®åº“ schemaï¼š
   ```bash
   psql $DATABASE_URL -f storage/ddl.sql
   ```

### 2. é‡‡é›†ä¸å…¥æ¹–

- æ ¸å¿ƒè„šæœ¬ï¼š`pipelines/ingest_raw.py`
- ç”¨é€”ï¼šè°ƒç”¨äº§å“ä¸»ä½“ã€æ—¶é—´åºåˆ—ã€è¯„è®ºã€å…³é”®è¯ç­‰ APIï¼Œå°†åŸå§‹ JSON å†™å…¥å¯¹è±¡å­˜å‚¨æˆ–æ•°æ®åº“åŸå§‹è¡¨ã€‚
- å¿«é€Ÿè¿è¡Œï¼š
  ```bash
  python -m pipelines.ingest_raw --date 2024-05-01 --marketplace US --limit 500
  ```
- å¸¸è§å‚æ•°ï¼š
  - `--date`ï¼šå¯¹é½ä¸šåŠ¡æ—¥ï¼›ç¼ºçœæ—¶é»˜è®¤ä»Šæ—¥ã€‚
  - `--marketplace`ï¼šç«™ç‚¹ä»£ç ï¼ˆUSã€JPã€DE ç­‰ï¼‰ã€‚
  - `--limit`ï¼šæ§åˆ¶å•æ¬¡é‡‡é›† ASIN æ•°é‡ï¼Œæ¨èå°ç™½ä» 100-500 å¼€å§‹ã€‚
- è¿è¡Œå®Œæˆåï¼Œå¯åœ¨ `storage/raw/`ï¼ˆæˆ–æ•°æ®åº“ `raw_` è¡¨ï¼‰ä¸­æŸ¥çœ‹åŸå§‹æ•°æ®ï¼ŒåŒæ—¶ `logs/` ä¸­ä¼šç”Ÿæˆé‡‡é›†æŠ¥å‘Šã€‚

### 3. æ ‡å‡†åŒ–ä¸è´¨é‡æ ¡éªŒ

- æ ¸å¿ƒè„šæœ¬ï¼š`pipelines/etl_standardize.py`
- ç”¨é€”ï¼šç»“æ„åŒ–åŸå§‹ JSONã€ç»Ÿä¸€æ•°æ®ç±»å‹ã€å‰”é™¤å¼‚å¸¸è®°å½•ï¼Œå¹¶ç”Ÿæˆè´¨é‡æŒ‡æ ‡ã€‚
- å¿«é€Ÿè¿è¡Œï¼š
  ```bash
  python -m pipelines.etl_standardize --date 2024-05-01
  ```
- éªŒæ”¶æ–¹æ³•ï¼š
  - æ£€æŸ¥æ•°æ®åº“ä¸­ `fact_product_daily` ç­‰äº‹å®è¡¨æ˜¯å¦å‡ºç°å¯¹åº”æ—¥æœŸæ•°æ®ã€‚
  - é˜…è¯» `output/quality_report_2024-05-01.json` äº†è§£ç¼ºå¤±ç‡ã€é‡å¤ç‡ç­‰å…³é”®æŒ‡æ ‡ã€‚

### 4. ç‰¹å¾æ„å»º

- æ ¸å¿ƒè„šæœ¬ï¼š`pipelines/features_build.py`
- ç”¨é€”ï¼šä¾æ®æ ‡å‡†åŒ–äº‹å®è¡¨è®¡ç®—æ»šåŠ¨çª—å£æŒ‡æ ‡ï¼ŒåŒ…æ‹¬ BSR è¶‹åŠ¿ã€ä»·æ ¼æ³¢åŠ¨ã€è¯„è®ºé€Ÿåº¦ã€Listing è´¨é‡ç­‰ã€‚
- å¿«é€Ÿè¿è¡Œï¼š
  ```bash
  python -m pipelines.features_build --date 2024-05-01
  ```
- ç»“æœä½ç½®ï¼š
  - æ•°æ®åº“å­˜å‚¨äº `feature_product_window` ç­‰è¡¨ã€‚
  - `output/features_summary_2024-05-01.csv` æä¾›äººå·¥å®¡é˜…ç”¨çš„ç‰¹å¾æ±‡æ€»ã€‚

### 5. çˆ†å‘åº¦è¯„åˆ†

- æ ¸å¿ƒè„šæœ¬ï¼š`pipelines/score_baseline.py`
- ç”¨é€”ï¼šæŒ‰ç«™ç‚¹/å“ç±»æ‰§è¡Œç¨³å¥ Z-Scoreï¼Œå¾—åˆ°ç»¼åˆçˆ†å‘åº¦è¯„åˆ†ï¼Œå¯è°ƒæ•´æƒé‡ã€‚
- å¿«é€Ÿè¿è¡Œï¼š
  ```bash
  python -m pipelines.score_baseline --date 2024-05-01 --weights config/score_weights.example.yaml
  ```
- è¾“å‡ºæ£€æŸ¥ï¼š
  - æ•°æ®åº“è¡¨ `score_baseline_daily` å­˜å‚¨æœ€ç»ˆç»“æœã€‚
  - `output/score_rank_2024-05-01.parquet` ä¾¿äº BI æˆ– Notebook ç»§ç»­åˆ†æã€‚

### 6. æ•°æ®å¯¼å‡ºä¸æŠ¥è¡¨

- å¯æ‰§è¡Œ SQLï¼š`reporting/dashboard_queries.sql` ä¸­åŒ…å«ç”¨äºä»ªè¡¨ç›˜çš„è§†å›¾/æŸ¥è¯¢ï¼›è‹¥å¯ç”¨ AI åŠŸèƒ½ï¼Œä¼š LEFT JOIN `ai_comment_summaries` ä¸ `ai_keyword_clusters`ã€‚
- å‘¨æŠ¥è„šæœ¬ï¼š
  ```bash
  python -m reporting.weekly_report --date 2024-05-01 --output reports/
  ```
  - é»˜è®¤ä¼šç”Ÿæˆ Excel/Markdown ä¸¤ç§æ ¼å¼ã€‚
  - è‹¥ AI åŠŸèƒ½å…³é—­ï¼Œå°†è‡ªåŠ¨å›é€€åˆ°ä¼ ç»Ÿå‘¨æŠ¥å†…å®¹ï¼›è‹¥å¼€å¯ä½†æŸ¥è¯¢å¤±è´¥ï¼Œä¹Ÿä¼šè‡ªåŠ¨é™çº§å¹¶åœ¨æ–‡æ¡£ä¸­æ˜¾ç¤ºâ€œå¾…è¿è¥å®¡æ ¸â€å ä½å†…å®¹ã€‚
- BI é…ç½®æé†’ï¼š`reporting/dashboard_queries.sql` ä¸­æ³¨æ˜ `-- TODO(manual): BI å›¾è¡¨é…ç½®ç”±è¿è¥ç¡®è®¤`ï¼Œä¸Šçº¿å‰è¯·ç”±ä¸šåŠ¡è¿è¥æœ€ç»ˆç¡®è®¤å„å›¾è¡¨æ˜ å°„å…³ç³»ã€‚

## æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°æ‰‹å†Œ

1. **å‡†å¤‡è®­ç»ƒæ•°æ®**ï¼šç¡®ä¿ä¸Šè¿°æµæ°´çº¿å·²ç”Ÿæˆæ‰€éœ€ç‰¹å¾ä¸æ ‡ç­¾ï¼ˆé€šå¸¸åœ¨ `feature_store` è§†å›¾ä¸­æ•´åˆï¼‰ã€‚
2. **å¯åŠ¨è®­ç»ƒ**ï¼š
   ```bash
   python -m training.train_rank \
     --train-start 2024-04-01 --train-end 2024-04-30 \
     --valid-start 2024-05-01 --valid-end 2024-05-07 \
     --output-dir runs/rank_v1
   ```
3. **æŸ¥çœ‹ç»“æœ**ï¼š
   - `runs/rank_v1/metrics.json`ï¼šæ•´ä½“æŒ‡æ ‡ä¸æ›²çº¿åŸå§‹æ•°æ®ã€‚
   - `runs/rank_v1/metrics.csv`ï¼šé€‚åˆå¯¼å…¥è¡¨æ ¼å·¥å…·å¿«é€Ÿæ¯”è¾ƒã€‚
   - `runs/rank_v1/lift_curve.csv`ï¼šæŸ¥çœ‹ä¸åŒé˜ˆå€¼ä¸‹çš„å¬å›ç‡å’Œæå‡å¹…åº¦ã€‚
4. **æ³¨å†Œæ¨¡å‹**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   python -m training.registry register \
     --name rank_v1 \
     --artifact-uri runs:/rank_v1/model \
     --signature runs/rank_v1/signature.json \
     --metric ndcg_10=0.42
   ```
   è‹¥æœªéƒ¨ç½² MLflowï¼Œå¯æ·»åŠ  `--local --registry-file runs/registry.json`ï¼Œä»¥ JSON æ–¹å¼è®°å½•ç‰ˆæœ¬ã€‚

## åœ¨çº¿æ¨ç†ä¸æœåŠ¡æ‰‹å†Œ

1. **ç¦»çº¿æ‰¹é‡æ¨ç†**ï¼š
   ```bash
   python -m inference.batch_predict \
     --score-date 2024-05-01 \
     --model-uri runs:/rank_v1/model \
     --output-path exports/batch_predictions_2024-05-01.parquet
   ```
2. **åœ¨çº¿æœåŠ¡éª¨æ¶**ï¼š`inference/service/` æä¾› FastAPI ç¤ºä¾‹ï¼Œå¯é€šè¿‡ `uvicorn inference.service.app:app --reload` å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚
3. **æ¨¡å‹çƒ­æ›´æ–°å»ºè®®**ï¼šç»“åˆ `training/registry.py` çš„ `promote` å‘½ä»¤éªŒè¯ç­¾åå…¼å®¹åå†åˆ‡æ¢ç”Ÿäº§æ¨¡å‹ã€‚

## æŠ¥è¡¨/BI ä¸ AI æ‰©å±•åŠŸèƒ½

- **ä»ªè¡¨ç›˜æ•°æ®**ï¼š`reporting/dashboard_queries.sql` æä¾›è§†å›¾å®šä¹‰ï¼Œå¯ç›´æ¥è¢« BI å·¥å…·ï¼ˆå¦‚ Tableauã€Power BIï¼‰æ¶ˆè´¹ã€‚
- **AI æ‘˜è¦/å…³é”®è¯**ï¼š
  - å¯ç”¨æ–¹å¼ï¼šåœ¨ `config/settings.yaml` ä¸­å°† `ai.enabled` è®¾ä¸º `true` å¹¶é…ç½® `ai.comment_summary_table`ã€`ai.keyword_cluster_table`ã€‚
  - å‘¨æŠ¥æ‰©å±•ï¼š`reporting/weekly_report.py` ä¼šè‡ªåŠ¨æ–°å¢â€œAI è¯„è®ºæ‘˜è¦â€ä¸â€œAI å…³é”®è¯èšç±»â€ç« èŠ‚ï¼Œé»˜è®¤æ–‡æ¡ˆä¸ºâ€œå¾…è¿è¥å®¡æ ¸â€ï¼Œè¿è¥ç¡®è®¤åå¯æ›¿æ¢ä¸ºæ­£å¼å†…å®¹ã€‚
- **å¹²è·‘å·¥å…·**ï¼š`reporting/dry_run_dashboard_queries.py` æ”¯æŒåœ¨æ— çœŸå® AI è¡¨æ—¶æ¨¡æ‹Ÿæ•°æ®ï¼Œå¸®åŠ©è¿è¥æå‰æ£€æŸ¥å›¾è¡¨ç»“æ„ã€‚

## ç›‘æ§ã€æ²»ç†ä¸æ’éšœæŒ‡å—

- **æ—¥å¿—ä½“ç³»**ï¼š`utils/logging.py` è¾“å‡º JSON ç»“æ„ï¼Œä¾¿äºæ¥å…¥ ELK/Datadogï¼›å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾ç½®ç»Ÿä¸€çš„æ—¥å¿—é‡‡é›†å™¨ã€‚
- **é™æµä¸é‡è¯•**ï¼š`utils/rate_limiter.py`ã€`utils/backoff.py` å†…ç½®æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œåº”å¯¹ 429/5xx å“åº”ã€‚
- **è´¨é‡éªŒè¯**ï¼š`utils/validators.py` æ”¯æŒç¼ºå¤±ç‡ã€å¼‚å¸¸å€¼æ£€æµ‹ï¼Œå¹¶å¯å°†ç»“æœæ¨é€è‡³å‘Šè­¦æ¸ é“ã€‚
- **æ•…éšœæ’æŸ¥é€ŸæŸ¥è¡¨**ï¼š
  | ç—‡çŠ¶ | å»ºè®®æ’æŸ¥ |
  | --- | --- |
  | é¢‘ç¹å‡ºç° 429 å“åº” | é™ä½ `config/settings.yaml` ä¸­çš„ QPM æˆ–è”ç³» Amazon æ”¯æŒè°ƒæ•´é™æµ |
  | ç¼ºå¤±æ¯æ—¥æ•°æ® | æ ¸å¯¹è´¨é‡æŠ¥å‘Šä¸åŸå§‹è½½è·è®¡æ•°ï¼Œå¿…è¦æ—¶é‡æ–°æ‹‰å–å½“æ—¥æ•°æ® |
| è¯„åˆ†æ³¢åŠ¨è¾ƒå¤§ | æŸ¥çœ‹å“ç±» MAD/æƒé‡é…ç½®ï¼Œå¿…è¦æ—¶é‡æ–°æ ¡å‡†ç‰¹å¾æ ‡å‡†åŒ–ç­–ç•¥ |

## ä¸Šçº¿å‰ç«¯åˆ°ç«¯éªŒæ”¶æ¸…å•

> **ç›®çš„**ï¼šä¿è¯æ ‡ç­¾ã€æ’åºã€æ¨æ–­ã€Registryã€æŠ¥è¡¨ã€å‘Šè­¦ä¸æ–‡æ¡£åœ¨çœŸå®ç¯å¢ƒä¸­çš„é—­ç¯å¯ç”¨æ€§ã€‚å»ºè®®åœ¨ç°åº¦ç¯å¢ƒå®Œæˆå¦‚ä¸‹æ­¥éª¤å¹¶è®°å½•æˆªå›¾/æ—¥å¿—ã€‚

1. **æ ‡ç­¾ä¸æ³„éœ²å¥‘çº¦**
   - è¿è¡Œ `pytest tests/test_training.py::test_feature_leakage_guard`ï¼Œç¡®è®¤â€œæ³„éœ²å¥‘çº¦â€å®ˆå«é€šè¿‡ã€‚
   - å¦‚éœ€å†æ¬¡æ ¸å¯¹é˜ˆå€¼ï¼Œå¯è¿è¡Œï¼š
     ```bash
     python - <<'PY'
     from training.build_labels import Thresholds
     print(Thresholds())  # r=1.6, p=0.2(=20%), delta=1.0 (>0)
     PY
     ```
     å¹¶åœ¨ `config/labeling.yaml`ï¼ˆè‹¥æœ‰è‡ªå®šä¹‰ï¼‰ä¸éƒ¨ç½²ç¯å¢ƒå‚æ•°ä¿æŒä¸€è‡´ã€‚
2. **æ’åæ•ˆæœ**
   - ä½¿ç”¨è®­ç»ƒæ ·æœ¬ç›®å½•ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™… `train_samples_rank` è¾“å‡ºè·¯å¾„ï¼‰æ‰§è¡Œï¼š
     ```bash
     python -m training.train_rank \
       --data-path data/rank/train_samples  \
       --output-dir runs/rank_acceptance \
       --run-name acceptance_check
     ```
   - åœ¨ `runs/rank_acceptance/metrics.csv` æˆ– `metrics.json` ä¸­ç¡®è®¤ `ndcg@20` â‰¥ åŸºçº¿ +8%ï¼Œå¹¶è®°å½• `recall@20`ã€`map`ã€`lift@20`ã€‚
   - è‹¥éœ€å¯¹æ¯”åŸºçº¿ï¼Œå¯å°†äº§å‡ºä¸ `docs/release_checklist.md` ä¸­è®°å½•çš„ä¸Šä¸€ç‰ˆæœ¬æŒ‡æ ‡æ¯”å¯¹ã€‚
3. **æ¨æ–­æ€§èƒ½**
   - å¯åŠ¨æ¯æ—¥æ‰¹å¤„ç†ï¼š`python -m inference.batch_predict --score-date <D>`ï¼Œç¡®è®¤æ€»è€—æ—¶ â‰¤ 30 åˆ†é’Ÿï¼ˆå¯ç»“åˆ `utils/timer.py` æ—¥å¿—ï¼‰ã€‚
   - æ£€æŸ¥æ•°æ®åº“è¡¨/è§†å›¾ `pred_rank_daily` ä¸ `reporting.dashboard_queries.sql` æš´éœ²çš„è§†å›¾ï¼Œç¡®è®¤å½“æ—¥å¯æŸ¥ã€‚
4. **Registry å…¨é“¾è·¯**
   - æŒ‰é¡ºåºæ‰§è¡Œæ³¨å†Œã€æ™‹å‡ä¸å›æ»šï¼š
     ```bash
     python -m training.registry register --name rank_v1 --artifact-uri runs:/rank_v1/model --stage Staging
     python -m training.registry promote --name rank_v1 --version 1 --to Production
     python -m training.registry demote --name rank_v1 --version 1 --to Archived
     ```
     ï¼ˆè‹¥å·²æœ‰å¤šç‰ˆæœ¬ï¼Œè¯·å°† `--version` æ›¿æ¢ä¸ºå®é™…ç¼–å·ã€‚ï¼‰
   - æ£€æŸ¥ `runs/registry.json` æˆ– MLflow UIï¼Œç¡®è®¤ç‰ˆæœ¬ç­¾åæ ¡éªŒé€šè¿‡ä¸”å›æ»šæˆåŠŸã€‚
5. **æŠ¥è¡¨ç”Ÿæˆï¼ˆAI å¼€/å…³ï¼‰**
   - ä¿æŒ `config/settings.yaml` ä¸­ `ai.enabled=false` è¿è¡Œ `python -m reporting.weekly_report --date <W>`ï¼Œç¡®è®¤å‘¨æŠ¥æ— æŠ¥é”™ã€‚
   - å°† `ai.enabled=true` å¹¶é…ç½® AI è¡¨ååå†æ¬¡è¿è¡Œï¼Œç¡®ä¿æ–°å¢ç« èŠ‚å‡ºç°ä¸”å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä¸ºä¼ ç»Ÿå†…å®¹ã€‚
6. **å‘Šè­¦éªŒè¯**
   - è¿è¡Œ `python -m reporting.dry_run_alerts`ï¼Œä½¿ç”¨å†…ç½®æ ·ä¾‹æ•°æ®è§¦å‘ TopN å‘½ä¸­ç‡ã€PSIã€æ—¶å»¶å‘Šè­¦ã€‚
   - æ ¹æ®è¾“å‡ºæ£€æŸ¥é‚®ä»¶/æœºå™¨äººæ¸ é“æ˜¯å¦æ”¶åˆ°é€šçŸ¥ï¼Œå¿…è¦æ—¶æ›¿æ¢ `_DummySMTPClient` ä¸ºçœŸå®å‡­è¯åå†è¯•ã€‚
7. **æ–‡æ¡£æ£€æŸ¥**
   - å®¡æ ¸ `docs/model_card_template.md`ã€`docs/ops_runbook.md` ä¸ `docs/api_contract.md` æ˜¯å¦å¡«å†™å®Œæ¯•ã€‚
   - å°†æœ¬æ¬¡éªŒæ”¶çš„æŒ‡æ ‡ã€æˆªå›¾ä¸å®¡æ‰¹è®°å½•æ›´æ–°åˆ° `docs/release_checklist.md`ï¼Œå¹¶ç¡®ä¿ README å¯¼èˆªå†…å®¹ä¸å®é™…å®ç°ä¸€è‡´ã€‚

## Docker éƒ¨ç½²å…¨é›†

ä½¿ç”¨ Docker å¯åœ¨ä»»ä½•ç¯å¢ƒä¿æŒä¸€è‡´ä½“éªŒï¼Œé€‚åˆå›¢é˜Ÿåä½œæˆ–å¿«é€Ÿè½åœ°ã€‚

### 1. å‡†å¤‡é…ç½®

```bash
cd ops/docker
cp mlflow-minio.env.example mlflow-minio.env
cp mlflow-postgres.env.example mlflow-postgres.env
# ä¿®æ”¹å‡­è¯ã€ç«¯å£ã€S3 è·¯å¾„ç­‰ä¿¡æ¯
```

### 2. è®­ç»ƒæ ˆï¼ˆå«ä¾èµ–ï¼‰

```bash
docker compose -f docker-compose.training.yaml up --build
```

- åŒ…å«è®­ç»ƒé•œåƒã€PostgreSQLã€MinIOã€MLflowã€‚
- è¿›å…¥å®¹å™¨ï¼š`docker compose exec trainer bash`ï¼Œå³å¯è¿è¡Œ `python -m training.train_rank ...`ã€‚

### 3. æ¨ç†æ ˆ

```bash
docker compose -f docker-compose.inference.yaml up --build
```

- è‡ªåŠ¨åŠ è½½æœ€æ–°æ¨¡å‹æƒé‡ã€‚
- æš´éœ² FastAPI æœåŠ¡ï¼ˆé»˜è®¤ 8080 ç«¯å£ï¼‰ã€‚

### 4. ç‹¬ç«‹ MLflow æœåŠ¡ï¼ˆå¯é€‰ï¼‰

```bash
docker compose -f docker-compose.mlflow.yaml up --build
```

- Traefik è´Ÿè´£åå‘ä»£ç†ä¸ TLSã€‚
- å¤åˆ¶ `traefik/users.htpasswd.example` ä¸º `users.htpasswd` åå¡«å†™çœŸå®è´¦å·ã€‚

> **æç¤º**ï¼šå¦‚éœ€ä»å®¿ä¸»æœºè®¿é—® MinIO æˆ– PostgreSQLï¼Œè¯·ç¡®ä¿ `.env` ä¸ Compose æ–‡ä»¶ä¸­çš„ç«¯å£æ˜ å°„ä¸€è‡´ï¼Œå¹¶åœ¨é˜²ç«å¢™ä¸­æ”¾è¡Œç›¸å…³ç«¯å£ã€‚

## å¸¸è§é—®é¢˜ä¸åç»­è§„åˆ’

- **æˆ‘å¯ä»¥åªè¿è¡Œéƒ¨åˆ†æµç¨‹å—ï¼Ÿ** å¯ä»¥ã€‚è·³è¿‡æŸä¸€é˜¶æ®µå‰ï¼Œè¯·ç¡®ä¿ä¸‹æ¸¸è„šæœ¬æœ‰å¯¹åº”çš„è¾“å…¥æ•°æ®æˆ–ä½¿ç”¨å¹²è·‘æ•°æ®ã€‚
- **å¦‚ä½•ç¼–æ’å®šæ—¶ä»»åŠ¡ï¼Ÿ** å‚è€ƒ `jobs/cron.md` æˆ– `jobs/airflow_dags.py`ï¼Œé‡Œé¢æä¾›äº† cron è¡¨è¾¾å¼ä¸ Airflow DAG ç¤ºä¾‹ã€‚
- **å¦‚ä½•ç»´æŠ¤æ¨¡å‹å¡ï¼Ÿ** ä½¿ç”¨ [`docs/model_card_template.md`](docs/model_card_template.md)ï¼Œå‘å¸ƒæ—¶å¤åˆ¶ä¸ºæ–°ç‰ˆæœ¬å¹¶æ›´æ–°æŒ‡æ ‡ã€å®¡æ‰¹å†å²ã€‚
- **åç»­è§„åˆ’**ï¼š
  - æ‰©å±• BI ä»ªè¡¨ç›˜ä¸ AI è¯„åˆ†çš„è”åŠ¨ç­–ç•¥ã€‚
  - å¼ºåŒ–æ•°æ®éªŒè¯ä¸è‡ªåŠ¨åŒ–å›æ»šæœºåˆ¶ã€‚
  - ä¸°å¯ŒæŒç»­äº¤ä»˜ä¸ç°åº¦å‘å¸ƒå·¥å…·é“¾ã€‚

ç¥ä½ ä½¿ç”¨é¡ºåˆ©ï¼å¦‚é‡é—®é¢˜ï¼Œå…ˆå‚è€ƒæœ¬ README å¯¹åº”ç« èŠ‚ï¼Œå†æŸ¥çœ‹ `tests/` ä¸­çš„ç¤ºä¾‹æˆ–æäº¤ Issue ä¸æˆ‘ä»¬äº¤æµã€‚
